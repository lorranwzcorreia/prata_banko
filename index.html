<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¶ Sistema Unificado - Banco Prata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
        }
        
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card { 
            border-radius: 15px; 
            border: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        
        .card-header {
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: 600;
        }
        
        .progress { 
            height: 25px; 
            border-radius: 12px; 
            background: #e9ecef; 
        }
        
        .progress-bar { 
            border-radius: 12px; 
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); 
            border: none; 
            padding: 12px 25px;
            font-weight: 600;
        }
        
        .btn-success { 
            background: linear-gradient(135deg, var(--success) 0%, #4895ef 100%); 
            border: none; 
            padding: 12px 25px;
            font-weight: 600;
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, var(--warning) 0%, #b5179e 100%); 
            border: none; 
            padding: 12px 25px;
            font-weight: 600;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 10px 20px;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: transparent;
        }
        
        .stats-card {
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .stats-card.success { border-left-color: var(--success); }
        .stats-card.warning { border-left-color: var(--warning); }
        .stats-card.info { border-left-color: var(--info); }
        
        .badge-phase {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .phase-1 { background: #cce5ff; color: #004085; }
        .phase-2 { background: #d4edda; color: #155724; }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: #f8f9fa;
        }
        
        .file-item.selected {
            background: #e3f2fd;
            border-left: 3px solid var(--primary);
        }
        
        .task-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }
        
        .task-item.success { border-left-color: var(--success); }
        .task-item.processing { border-left-color: var(--primary); }
        .task-item.error { border-left-color: var(--warning); }
        
        .modal-content {
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho -->
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold mb-3">
                <i class="bi bi-bank"></i> SISTEMA UNIFICADO BANCO PRATA
            </h1>
            <p class="lead text-muted mb-4">
                Sistema completo de autoriza√ß√µes e consultas em uma √∫nica interface
            </p>
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-3 fs-4"></i>
                            <div>
                                <strong>3 Op√ß√µes Dispon√≠veis:</strong> Escolha abaixo qual processo deseja realizar
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Abas de Op√ß√µes -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-menu-button-wide"></i> Selecione a Op√ß√£o Desejada</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-auth" data-bs-toggle="tab" data-bs-target="#auth-tab" type="button">
                            <i class="bi bi-shield-check"></i> üîê Apenas Autoriza√ß√µes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-consulta" data-bs-toggle="tab" data-bs-target="#consulta-tab" type="button">
                            <i class="bi bi-search"></i> üí∞ Apenas Consultas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-completo" data-bs-toggle="tab" data-bs-target="#completo-tab" type="button">
                            <i class="bi bi-arrow-repeat"></i> üîÑ Fluxo Completo
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-4" id="mainTabsContent">
                    
                    <!-- ABA 1: Apenas Autoriza√ß√µes -->
                    <div class="tab-pane fade show active" id="auth-tab" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="bi bi-upload"></i> Upload para Autoriza√ß√£o</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Arquivo com clientes para autorizar</label>
                                            <input class="form-control" type="file" id="authFileInput" accept=".txt">
                                            <div class="form-text">
                                                Formato: <code>CPF NOME TELEFONE</code><br>
                                                Exemplo: <code>044.892.990-28 RAFAELA MACHADO 51991950076</code>
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-primary w-100" onclick="iniciarAutorizacao()" id="authUploadBtn">
                                            <i class="bi bi-play-fill"></i> Iniciar Autoriza√ß√µes
                                        </button>
                                        
                                        <div id="authStatus" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white">
                                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Progresso</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="authProgressContainer">
                                            <p class="text-muted text-center">Nenhuma autoriza√ß√£o em andamento</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="bi bi-download"></i> Resultados</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="authResultsContainer">
                                            <p class="text-muted text-center">Os resultados aparecer√£o aqui</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ABA 2: Apenas Consultas -->
                    <div class="tab-pane fade" id="consulta-tab" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-warning text-white">
                                        <h5 class="mb-0"><i class="bi bi-search"></i> Consultar Clientes Autorizados</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Selecione o arquivo de autorizados</label>
                                            <div class="file-list" id="authFilesList">
                                                <p class="text-muted">Carregando arquivos...</p>
                                            </div>
                                            <div class="form-text mt-2">
                                                Ou fa√ßa upload de um novo arquivo:
                                            </div>
                                            <input class="form-control mt-2" type="file" id="consultaFileInput" accept=".txt">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="reconsultaSwitch" checked>
                                                <label class="form-check-label" for="reconsultaSwitch">
                                                    <strong>Fazer reconsulta (Fase 2)</strong>
                                                </label>
                                                <div class="form-text">
                                                    Recomendado para resultados mais precisos
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-warning w-100" onclick="iniciarConsulta()" id="consultaUploadBtn">
                                            <i class="bi bi-search"></i> Iniciar Consultas
                                        </button>
                                        
                                        <div id="consultaStatus" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Progresso das Consultas</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="consultaProgressContainer">
                                            <p class="text-muted text-center">Nenhuma consulta em andamento</p>
                                        </div>
                                        
                                        <div id="consultaStats" class="mt-3" style="display: none;">
                                            <div class="row">
                                                <div class="col-6 mb-2">
                                                    <div class="stats-card success">
                                                        <small class="text-muted">‚úÖ Fase 1</small>
                                                        <div id="statFase1">0/0</div>
                                                    </div>
                                                </div>
                                                <div class="col-6 mb-2">
                                                    <div class="stats-card">
                                                        <small class="text-muted">üîÑ Fase 2</small>
                                                        <div id="statFase2">0/0</div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="stats-card warning">
                                                        <small class="text-muted">‚ùå Ineleg√≠veis</small>
                                                        <div id="statInelegiveis">0</div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="stats-card info">
                                                        <small class="text-muted">‚ö†Ô∏è Erros</small>
                                                        <div id="statErros">0</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="bi bi-file-earmark-excel"></i> Resultados</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="consultaResultsContainer">
                                            <p class="text-muted text-center">Os resultados aparecer√£o aqui</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ABA 3: Fluxo Completo -->
                    <div class="tab-pane fade" id="completo-tab" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="bi bi-1-circle"></i> Passo 1: Autorizar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Arquivo com clientes</label>
                                            <input class="form-control" type="file" id="completoAuthFile" accept=".txt">
                                        </div>
                                        
                                        <button class="btn btn-primary w-100 mb-3" onclick="iniciarFluxoCompleto('auth')">
                                            <i class="bi bi-shield-check"></i> Iniciar Autoriza√ß√µes
                                        </button>
                                        
                                        <div id="fluxoAuthStatus"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header bg-warning text-white">
                                        <h5 class="mb-0"><i class="bi bi-2-circle"></i> Passo 2: Consultar</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Ap√≥s concluir as autoriza√ß√µes, voc√™ poder√° consultar os clientes autorizados automaticamente.</p>
                                        
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="fluxoReconsulta" checked>
                                                <label class="form-check-label">
                                                    Fazer reconsulta
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-warning w-100" onclick="iniciarFluxoCompleto('consulta')" id="fluxoConsultaBtn" disabled>
                                            <i class="bi bi-search"></i> Aguardando autoriza√ß√µes...
                                        </button>
                                        
                                        <div id="fluxoConsultaStatus" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="bi bi-3-circle"></i> Passo 3: Resultados</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Ap√≥s as consultas, baixe o Excel completo com todos os resultados.</p>
                                        
                                        <div id="fluxoResultados">
                                            <p class="text-center text-muted">
                                                <i class="bi bi-hourglass-split fs-1"></i><br>
                                                Aguardando processamento...
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="bi bi-activity"></i> Progresso do Fluxo</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-4">
                                                <div class="p-3 rounded" id="step1Indicator" style="background: #e9ecef;">
                                                    <i class="bi bi-shield-check fs-1"></i>
                                                    <h5 class="mt-2">Autoriza√ß√µes</h5>
                                                    <div id="step1Status">Aguardando</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="p-3 rounded" id="step2Indicator" style="background: #e9ecef;">
                                                    <i class="bi bi-search fs-1"></i>
                                                    <h5 class="mt-2">Consultas</h5>
                                                    <div id="step2Status">Aguardando</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="p-3 rounded" id="step3Indicator" style="background: #e9ecef;">
                                                    <i class="bi bi-file-earmark-excel fs-1"></i>
                                                    <h5 class="mt-2">Resultados</h5>
                                                    <div id="step3Status">Aguardando</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarefas Recentes -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Autoriza√ß√µes Recentes</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentAuthTasks">
                            <p class="text-muted text-center">Carregando...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Consultas Recentes</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentConsultaTasks">
                            <p class="text-muted text-center">Carregando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rodap√© -->
        <div class="mt-4 text-center">
            <div class="alert alert-light">
                <small class="text-muted">
                    <i class="bi bi-cpu"></i> Sistema Unificado Banco Prata v1.0 | 
                    <i class="bi bi-folder"></i> Estrutura organizada nas pastas existentes
                </small>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Detalhes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    Carregando...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Vari√°veis globais
        let currentAuthTask = null;
        let currentConsultaTask = null;
        let fluxoAuthTask = null;
        let fluxoConsultaTask = null;
        let authCheckInterval = null;
        let consultaCheckInterval = null;
        let selectedAuthFile = null;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            carregarArquivosAutorizados();
            carregarTarefasRecentes();
            
            // Atualizar a cada 10 segundos
            setInterval(carregarTarefasRecentes, 10000);
        });
        
        // ========== FUN√á√ïES GERAIS ==========
        
        function showAlert(message, type, containerId = null) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            if (containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                container.appendChild(alert);
            } else {
                // Mostrar no topo
                const mainContainer = document.querySelector('.container');
                mainContainer.insertBefore(alert, mainContainer.firstChild);
            }
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // ========== ABA 1: AUTORIZA√á√ïES ==========
        
        async function iniciarAutorizacao() {
            const fileInput = document.getElementById('authFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Selecione um arquivo primeiro!', 'warning');
                return;
            }
            
            const btn = document.getElementById('authUploadBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Enviando...';
            
            const formData = new FormData();
            formData.append('file', file);
            
            showAlert('Enviando arquivo para autoriza√ß√£o...', 'info', 'authStatus');
            
            try {
                const response = await fetch('/autorizar/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert(`Erro: ${data.error}`, 'danger', 'authStatus');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-play-fill"></i> Iniciar Autoriza√ß√µes';
                    return;
                }
                
                currentAuthTask = data.task_id;
                showAlert(`‚úÖ ${data.message}`, 'success', 'authStatus');
                
                // Iniciar monitoramento
                monitorarAutorizacao(currentAuthTask);
                
            } catch (error) {
                showAlert(`Erro de rede: ${error.message}`, 'danger', 'authStatus');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-fill"></i> Iniciar Autoriza√ß√µes';
            }
        }
        
        async function monitorarAutorizacao(taskId) {
            const progressContainer = document.getElementById('authProgressContainer');
            
            if (authCheckInterval) clearInterval(authCheckInterval);
            
            authCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/autorizar/status/${taskId}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        clearInterval(authCheckInterval);
                        atualizarProgressoAutorizacao(taskId, { status: 'error' });
                        showAlert('Tarefa n√£o encontrada!', 'danger', 'authStatus');
                        enableAuthButton();
                        return;
                    }
                    
                    // Atualizar progresso
                    atualizarProgressoAutorizacao(taskId, data);
                    
                    // Se conclu√≠do
                    if (data.status === 'completed') {
                        clearInterval(authCheckInterval);
                        mostrarResultadosAutorizacao(taskId);
                        enableAuthButton();
                        carregarArquivosAutorizados(); // Atualizar lista
                    }
                    
                    if (data.status === 'error') {
                        clearInterval(authCheckInterval);
                        showAlert('Autoriza√ß√µes falharam!', 'danger', 'authStatus');
                        enableAuthButton();
                    }
                    
                } catch (error) {
                    console.error('Erro ao monitorar:', error);
                }
            }, 2000);
        }
        
        function atualizarProgressoAutorizacao(taskId, data) {
            const progressContainer = document.getElementById('authProgressContainer');
            const progressPercent = data.progresso || 0;
            
            let statusBadge = '';
            if (data.status === 'processing') statusBadge = '<span class="badge bg-info">Processando</span>';
            if (data.status === 'completed') statusBadge = '<span class="badge bg-success">Conclu√≠do</span>';
            if (data.status === 'error') statusBadge = '<span class="badge bg-danger">Erro</span>';
            
            progressContainer.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <h6>Tarefa: ${taskId.substring(0, 10)}...</h6>
                        ${statusBadge}
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <small><strong>${data.processados || 0}/${data.total || 0}</strong> clientes</small>
                        <small><strong>${data.autorizados || 0}</strong> autorizados</small>
                    </div>
                    
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                             style="width: ${progressPercent}%">
                            ${progressPercent.toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="mt-2 text-muted">
                        <small>
                            ‚è±Ô∏è ${data.tempo_decorrido || 0}s decorridos
                            ${data.tempo_restante > 0 ? `| ‚è≥ ${data.tempo_restante}s restantes` : ''}
                        </small>
                    </div>
                </div>
            `;
        }
        
        async function mostrarResultadosAutorizacao(taskId) {
            try {
                const resultsContainer = document.getElementById('authResultsContainer');
                resultsContainer.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i> Autoriza√ß√µes Conclu√≠das!</h5>
                        <p>As autoriza√ß√µes foram processadas com sucesso.</p>
                        
                        <div class="mt-3">
                            <a href="/autorizar/download/${taskId}" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-download"></i> Baixar Clientes Autorizados
                            </a>
                        </div>
                        
                        <p class="mt-3 mb-0">
                            <strong>Pr√≥ximo passo:</strong> Use este arquivo na aba "Consultas" para consultar os valores.
                        </p>
                    </div>
                `;
                
            } catch (error) {
                showAlert('Erro ao obter resultados', 'danger', 'authStatus');
            }
        }
        
        function enableAuthButton() {
            const btn = document.getElementById('authUploadBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Iniciar Autoriza√ß√µes';
        }
        
        // ========== ABA 2: CONSULTAS ==========
        
        async function carregarArquivosAutorizados() {
            try {
                const response = await fetch('/listar/autorizados');
                const data = await response.json();
                
                if (data.success && data.arquivos.length > 0) {
                    const container = document.getElementById('authFilesList');
                    container.innerHTML = '';
                    
                    data.arquivos.forEach((arquivo, index) => {
                        const div = document.createElement('div');
                        div.className = `file-item ${index === 0 ? 'selected' : ''}`;
                        div.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <div>
                                    <input type="radio" name="authFile" value="${arquivo.caminho}" 
                                           ${index === 0 ? 'checked' : ''} 
                                           onchange="selecionarArquivo('${arquivo.caminho}')">
                                    <strong class="ms-2">${arquivo.nome}</strong>
                                </div>
                                <span class="badge bg-secondary">${arquivo.clientes} clientes</span>
                            </div>
                            <small class="text-muted">${arquivo.tamanho}</small>
                        `;
                        container.appendChild(div);
                        
                        if (index === 0) {
                            selectedAuthFile = arquivo.caminho;
                        }
                    });
                } else {
                    document.getElementById('authFilesList').innerHTML = 
                        '<p class="text-muted text-center">Nenhum arquivo de autorizados encontrado</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar arquivos:', error);
            }
        }
        
        function selecionarArquivo(caminho) {
            selectedAuthFile = caminho;
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Adicionar sele√ß√£o ao item clicado
            event.target.closest('.file-item').classList.add('selected');
        }
        
        async function iniciarConsulta() {
            const fazerReconsulta = document.getElementById('reconsultaSwitch').checked;
            const fileInput = document.getElementById('consultaFileInput');
            
            let modo = 'tarefa';
            let arquivoSelecionado = selectedAuthFile;
            
            // Se o usu√°rio fez upload de um novo arquivo
            if (fileInput.files[0]) {
                modo = 'arquivo';
                const file = fileInput.files[0];
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('modo', 'arquivo');
                formData.append('reconsulta', fazerReconsulta);
                
                return enviarConsulta(formData);
            }
            
            // Se est√° usando arquivo da lista
            if (!arquivoSelecionado) {
                showAlert('Selecione um arquivo da lista ou fa√ßa upload!', 'warning', 'consultaStatus');
                return;
            }
            
            const formData = new FormData();
            formData.append('modo', 'arquivo');
            formData.append('reconsulta', fazerReconsulta);
            // Nota: Para arquivos da lista, precisamos de uma abordagem diferente
            // Vamos usar o modo 'tarefa' ou precisamos de um endpoint diferente
            
            showAlert('Para arquivos da lista, use o fluxo completo ou fa√ßa upload do arquivo.', 'warning', 'consultaStatus');
        }
        
        async function enviarConsulta(formData) {
            const btn = document.getElementById('consultaUploadBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Enviando...';
            
            showAlert('Enviando para consulta...', 'info', 'consultaStatus');
            
            try {
                const response = await fetch('/consultar/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert(`Erro: ${data.error}`, 'danger', 'consultaStatus');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-search"></i> Iniciar Consultas';
                    return;
                }
                
                currentConsultaTask = data.task_id;
                showAlert(`‚úÖ ${data.message}${data.fazer_reconsulta ? ' (com reconsulta)' : ''}`, 'success', 'consultaStatus');
                
                // Mostrar estat√≠sticas
                document.getElementById('consultaStats').style.display = 'block';
                
                // Iniciar monitoramento
                monitorarConsulta(currentConsultaTask);
                
            } catch (error) {
                showAlert(`Erro de rede: ${error.message}`, 'danger', 'consultaStatus');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-search"></i> Iniciar Consultas';
            }
        }
        
        async function monitorarConsulta(taskId) {
            const progressContainer = document.getElementById('consultaProgressContainer');
            
            if (consultaCheckInterval) clearInterval(consultaCheckInterval);
            
            consultaCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/consultar/status/${taskId}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        clearInterval(consultaCheckInterval);
                        atualizarProgressoConsulta(taskId, { status: 'error' });
                        showAlert('Tarefa n√£o encontrada!', 'danger', 'consultaStatus');
                        enableConsultaButton();
                        return;
                    }
                    
                    // Atualizar progresso
                    atualizarProgressoConsulta(taskId, data);
                    
                    // Atualizar estat√≠sticas
                    atualizarEstatisticasConsulta(data.estatisticas);
                    
                    // Se conclu√≠do
                    if (data.status === 'completed') {
                        clearInterval(consultaCheckInterval);
                        mostrarResultadosConsulta(taskId);
                        enableConsultaButton();
                    }
                    
                    if (data.status === 'error') {
                        clearInterval(consultaCheckInterval);
                        showAlert('Consultas falharam!', 'danger', 'consultaStatus');
                        enableConsultaButton();
                    }
                    
                } catch (error) {
                    console.error('Erro ao monitorar:', error);
                }
            }, 2000);
        }
        
        function atualizarProgressoConsulta(taskId, data) {
            const progressContainer = document.getElementById('consultaProgressContainer');
            const progressPercent = data.progresso || 0;
            
            let faseBadge = '';
            if (data.fase_atual === 'fase1_consulta_inicial') {
                faseBadge = '<span class="badge phase-1">FASE 1</span>';
            } else if (data.fase_atual === 'fase2_reconsulta') {
                faseBadge = '<span class="badge phase-2">FASE 2</span>';
            } else if (data.fase_atual === 'concluido') {
                faseBadge = '<span class="badge bg-success">CONCLU√çDO</span>';
            }
            
            let statusBadge = '';
            if (data.status === 'processing') statusBadge = '<span class="badge bg-info">Processando</span>';
            if (data.status === 'completed') statusBadge = '<span class="badge bg-success">Conclu√≠do</span>';
            if (data.status === 'error') statusBadge = '<span class="badge bg-danger">Erro</span>';
            
            progressContainer.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <h6 class="mb-0">Tarefa: ${taskId.substring(0, 10)}...</h6>
                            ${faseBadge}
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <small><strong>${data.processados || 0}/${data.total || 0}</strong> clientes</small>
                        <small><strong>${progressPercent.toFixed(1)}%</strong></small>
                    </div>
                    
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: ${progressPercent}%">
                            ${data.fase_atual === 'fase1_consulta_inicial' ? 'Fase 1' : 
                              data.fase_atual === 'fase2_reconsulta' ? 'Fase 2' : 'Conclu√≠do'}
                        </div>
                    </div>
                    
                    <div class="mt-2 text-muted">
                        <small>
                            ‚è±Ô∏è ${data.tempo_decorrido || 0}s decorridos
                            ${data.tempo_restante > 0 ? `| ‚è≥ ${data.tempo_restante}s restantes` : ''}
                        </small>
                    </div>
                </div>
            `;
        }
        
        function atualizarEstatisticasConsulta(stats) {
            if (!stats) return;
            
            document.getElementById('statFase1').textContent = 
                `${stats.sucesso_fase1 || 0}/${stats.total || 0}`;
            
            document.getElementById('statFase2').textContent = 
                `${stats.sucesso_fase2 || 0}/${stats.total || 0}`;
            
            document.getElementById('statInelegiveis').textContent = 
                stats.inelegiveis || 0;
            
            document.getElementById('statErros').textContent = 
                stats.erros || 0;
        }
        
        async function mostrarResultadosConsulta(taskId) {
            try {
                const resultsContainer = document.getElementById('consultaResultsContainer');
                resultsContainer.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i> Consultas Conclu√≠das!</h5>
                        <p>As consultas foram processadas com sucesso.</p>
                        
                        <div class="mt-3">
                            <a href="/consultar/download/${taskId}" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-file-earmark-excel"></i> Baixar Resultados em Excel
                            </a>
                        </div>
                        
                        <p class="mt-3 mb-0">
                            <strong>Arquivo gerado:</strong> Excel completo com todas as informa√ß√µes.
                        </p>
                    </div>
                `;
                
            } catch (error) {
                showAlert('Erro ao obter resultados', 'danger', 'consultaStatus');
            }
        }
        
        function enableConsultaButton() {
            const btn = document.getElementById('consultaUploadBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search"></i> Iniciar Consultas';
        }
        
        // ========== ABA 3: FLUXO COMPLETO ==========
        
        async function iniciarFluxoCompleto(passo) {
            if (passo === 'auth') {
                const fileInput = document.getElementById('completoAuthFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showAlert('Selecione um arquivo para autorizar!', 'warning', 'fluxoAuthStatus');
                    return;
                }
                
                // Desabilitar outros passos
                document.getElementById('fluxoConsultaBtn').disabled = true;
                document.getElementById('fluxoConsultaBtn').innerHTML = 
                    '<i class="bi bi-hourglass-split"></i> Aguardando autoriza√ß√µes...';
                
                // Atualizar indicador
                atualizarIndicadorFluxo(1, 'processing', 'Processando...');
                
                const formData = new FormData();
                formData.append('file', file);
                
                showAlert('Iniciando autoriza√ß√µes...', 'info', 'fluxoAuthStatus');
                
                try {
                    const response = await fetch('/autorizar/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        showAlert(`Erro: ${data.error}`, 'danger', 'fluxoAuthStatus');
                        atualizarIndicadorFluxo(1, 'error', 'Erro');
                        return;
                    }
                    
                    fluxoAuthTask = data.task_id;
                    showAlert(`‚úÖ ${data.message}`, 'success', 'fluxoAuthStatus');
                    
                    // Monitorar autoriza√ß√£o
                    monitorarFluxoAutorizacao(fluxoAuthTask);
                    
                } catch (error) {
                    showAlert(`Erro: ${error.message}`, 'danger', 'fluxoAuthStatus');
                    atualizarIndicadorFluxo(1, 'error', 'Erro');
                }
                
            } else if (passo === 'consulta' && fluxoAuthTask) {
                const fazerReconsulta = document.getElementById('fluxoReconsulta').checked;
                
                // Atualizar indicador
                atualizarIndicadorFluxo(2, 'processing', 'Processando...');
                
                const formData = new FormData();
                formData.append('modo', 'tarefa');
                formData.append('auth_task_id', fluxoAuthTask);
                formData.append('reconsulta', fazerReconsulta);
                
                showAlert('Iniciando consultas...', 'info', 'fluxoConsultaStatus');
                
                try {
                    const response = await fetch('/consultar/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        showAlert(`Erro: ${data.error}`, 'danger', 'fluxoConsultaStatus');
                        atualizarIndicadorFluxo(2, 'error', 'Erro');
                        return;
                    }
                    
                    fluxoConsultaTask = data.task_id;
                    showAlert(`‚úÖ ${data.message}${data.fazer_reconsulta ? ' (com reconsulta)' : ''}`, 'success', 'fluxoConsultaStatus');
                    
                    // Monitorar consulta
                    monitorarFluxoConsulta(fluxoConsultaTask);
                    
                } catch (error) {
                    showAlert(`Erro: ${error.message}`, 'danger', 'fluxoConsultaStatus');
                    atualizarIndicadorFluxo(2, 'error', 'Erro');
                }
            }
        }
        
        async function monitorarFluxoAutorizacao(taskId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/autorizar/status/${taskId}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        clearInterval(interval);
                        atualizarIndicadorFluxo(1, 'error', 'Erro');
                        return;
                    }
                    
                    // Atualizar indicador
                    if (data.status === 'processing') {
                        atualizarIndicadorFluxo(1, 'processing', 
                            `${data.processados}/${data.total} (${data.progresso}%)`);
                    }
                    
                    // Se conclu√≠do
                    if (data.status === 'completed') {
                        clearInterval(interval);
                        atualizarIndicadorFluxo(1, 'completed', 
                            `Conclu√≠do: ${data.autorizados}/${data.total}`);
                        
                        // Habilitar pr√≥ximo passo
                        document.getElementById('fluxoConsultaBtn').disabled = false;
                        document.getElementById('fluxoConsultaBtn').innerHTML = 
                            '<i class="bi bi-search"></i> Iniciar Consultas';
                        
                        showAlert('Autoriza√ß√µes conclu√≠das! Agora inicie as consultas.', 'success', 'fluxoAuthStatus');
                    }
                    
                    if (data.status === 'error') {
                        clearInterval(interval);
                        atualizarIndicadorFluxo(1, 'error', 'Erro');
                        showAlert('Autoriza√ß√µes falharam!', 'danger', 'fluxoAuthStatus');
                    }
                    
                } catch (error) {
                    console.error('Erro:', error);
                }
            }, 2000);
        }
        
        async function monitorarFluxoConsulta(taskId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/consultar/status/${taskId}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        clearInterval(interval);
                        atualizarIndicadorFluxo(2, 'error', 'Erro');
                        return;
                    }
                    
                    // Atualizar indicador
                    if (data.status === 'processing') {
                        atualizarIndicadorFluxo(2, 'processing', 
                            `${data.processados}/${data.total} (${data.progresso}%)`);
                    }
                    
                    // Se conclu√≠do
                    if (data.status === 'completed') {
                        clearInterval(interval);
                        atualizarIndicadorFluxo(2, 'completed', 
                            `Conclu√≠do: ${data.estatisticas.sucesso_fase1}/${data.total}`);
                        atualizarIndicadorFluxo(3, 'completed', 'Pronto para download');
                        
                        // Mostrar resultado
                        document.getElementById('fluxoResultados').innerHTML = `
                            <div class="text-center">
                                <i class="bi bi-check-circle-fill text-success fs-1"></i>
                                <h5 class="mt-3">Consultas Conclu√≠das!</h5>
                                <p>${data.total} clientes processados</p>
                                
                                <a href="/consultar/download/${taskId}" class="btn btn-success btn-lg w-100">
                                    <i class="bi bi-download"></i> Baixar Excel Completo
                                </a>
                            </div>
                        `;
                        
                        showAlert('Fluxo completo conclu√≠do!', 'success', 'fluxoConsultaStatus');
                    }
                    
                    if (data.status === 'error') {
                        clearInterval(interval);
                        atualizarIndicadorFluxo(2, 'error', 'Erro');
                        showAlert('Consultas falharam!', 'danger', 'fluxoConsultaStatus');
                    }
                    
                } catch (error) {
                    console.error('Erro:', error);
                }
            }, 2000);
        }
        
        function atualizarIndicadorFluxo(passo, status, texto) {
            const indicator = document.getElementById(`step${passo}Indicator`);
            const statusElement = document.getElementById(`step${passo}Status`);
            
            statusElement.textContent = texto;
            
            // Resetar cores
            indicator.style.background = '#e9ecef';
            
            // Aplicar cores baseadas no status
            if (status === 'processing') {
                indicator.style.background = 'linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%)';
                indicator.style.color = 'white';
                statusElement.style.color = 'white';
            } else if (status === 'completed') {
                indicator.style.background = 'linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%)';
                indicator.style.color = 'white';
                statusElement.style.color = 'white';
            } else if (status === 'error') {
                indicator.style.background = 'linear-gradient(135deg, #f72585 0%, #b5179e 100%)';
                indicator.style.color = 'white';
                statusElement.style.color = 'white';
            } else {
                indicator.style.color = '';
                statusElement.style.color = '';
            }
        }
        
        // ========== FUN√á√ïES AUXILIARES ==========
        
        async function carregarTarefasRecentes() {
            try {
                const response = await fetch('/listar/tarefas');
                const data = await response.json();
                
                if (data.success) {
                    // Autoriza√ß√µes
                    const authContainer = document.getElementById('recentAuthTasks');
                    if (data.autorizacoes.length > 0) {
                        authContainer.innerHTML = '';
                        data.autorizacoes.forEach(task => {
                            const div = document.createElement('div');
                            div.className = `task-item ${task.status}`;
                            div.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <strong>${task.id.substring(0, 8)}...</strong>
                                    <span class="badge bg-${task.status === 'completed' ? 'success' : 
                                                              task.status === 'processing' ? 'primary' : 'secondary'}">
                                        ${task.status}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    ${task.autorizados}/${task.total} autorizados | ${task.tempo}s
                                </small>
                            `;
                            authContainer.appendChild(div);
                        });
                    } else {
                        authContainer.innerHTML = '<p class="text-muted text-center">Nenhuma tarefa recente</p>';
                    }
                    
                    // Consultas
                    const consultaContainer = document.getElementById('recentConsultaTasks');
                    if (data.consultas.length > 0) {
                        consultaContainer.innerHTML = '';
                        data.consultas.forEach(task => {
                            const div = document.createElement('div');
                            div.className = `task-item ${task.status}`;
                            div.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <strong>${task.id.substring(0, 8)}...</strong>
                                    <span class="badge bg-${task.status === 'completed' ? 'success' : 
                                                              task.status === 'processing' ? 'primary' : 'secondary'}">
                                        ${task.status}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    ${task.progresso}/${task.total} | ${task.tempo}s
                                </small>
                            `;
                            consultaContainer.appendChild(div);
                        });
                    } else {
                        consultaContainer.innerHTML = '<p class="text-muted text-center">Nenhuma tarefa recente</p>';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
            }
        }
    </script>
</body>
</html>